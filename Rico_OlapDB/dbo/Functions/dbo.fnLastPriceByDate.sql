CREATE FUNCTION dbo.fnLastPriceByDate (@D DATETIME)
 RETURNS TABLE 
  AS RETURN (
  SELECT CONVERT(VARCHAR(100), T1.V8_Fld14165, 1) AS Price_ID
  , CONVERT(VARCHAR(100), T1.V8_Fld14166, 1) AS Nom_ID
  , T1.V8_Fld14169 AS Price
  , T6.V8_Description AS Price_Name
  , T5.V8_Description AS Nom_Name
  FROM 
  (SELECT T4.V8_Fld14165, t4.V8_Fld14166, t4.V8_Fld14169 FROM (
    (SELECT T3.V8_Fld14165 AS Price_ID, T3.V8_Fld14166 AS Nom_ID, MAX(T3.V8_Period) AS MAXPERIOD
      FROM V8_InfoReg2049 T3
      WHERE T3.V8_Active = 1 AND T3.V8_Period <= @D
      GROUP BY T3.V8_Fld14165, T3.V8_Fld14166) T2
      INNER JOIN V8_InfoReg2049 T4 ON T2.Price_ID = T4.V8_Fld14165 AND T2.Nom_ID = T4.V8_Fld14166 and
         T2.MAXPERIOD = T4.V8_Period)) T1
  LEFT OUTER JOIN V8_Reference260 T5 ON T1.V8_Fld14166 = T5.V8_ID 
  LEFT OUTER JOIN V8_Reference390 T6 ON T1.V8_Fld14165 = T6.V8_ID 
 )